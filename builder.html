<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Map Builder</title>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1, h2 { color: #bb86fc; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .section {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }

        label { display: block; margin-bottom: 5px; color: #03dac6; font-weight: bold; }
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            background: #2c2c2c;
            border: 1px solid #444;
            color: #fff;
            border-radius: 4px;
            box-sizing: border-box;
            margin-bottom: 15px;
        }
        
        button {
            background-color: #bb86fc;
            color: #000;
            border: none;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            margin-right: 10px;
        }
        button.secondary { background-color: #333; color: #fff; border: 1px solid #555; }
        button:hover { opacity: 0.9; }

        .row { display: flex; gap: 20px; }
        .col { flex: 1; }

        pre {
            background: #000;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            color: #00ff00;
            max-height: 400px;
        }

        .status { margin-top: 10px; font-style: italic; color: #888; }
    </style>
</head>
<body>

    <h1>DeLorme Data Builder</h1>

    <!-- 1. LOAD EXISTING -->
    <div class="section">
        <h2>1. Load Existing JSON (Optional)</h2>
        <p>If you want to add to an existing file (e.g., <code>counties.json</code>), select it here. Otherwise, a new file will be created.</p>
        <input type="file" id="fileJson" accept=".json">
        <div id="jsonStatus" class="status">No existing file loaded. Creating new.</div>
    </div>

    <!-- 2. METADATA -->
    <div class="section">
        <h2>2. Entry Details</h2>
        <div class="row">
            <div class="col">
                <label>Group Name (File Label)</label>
                <input type="text" id="txtGroup" placeholder="e.g. California Counties">
            </div>
            <div class="col">
                <label>Entry Name (Page/County)</label>
                <input type="text" id="txtName" placeholder="e.g. San Joaquin">
            </div>
        </div>
    </div>

    <!-- 3. POLYGON DATA -->
    <div class="section">
        <h2>3. Polygon Data (CSV)</h2>
        <p>Select a CSV file containing <code>Lat,Lon</code> coordinates OR paste text below.</p>
        <input type="file" id="fileCsv" accept=".csv,.txt">
        <br><br>
        <label>Or Paste Lat,Lon Data Here:</label>
        <textarea id="txtCsvInput" rows="6" placeholder="38.24882,-121.20789..."></textarea>
    </div>

    <!-- ACTIONS -->
    <button onclick="processData()">GENERATE JSON</button>
    <button class="secondary" onclick="clearForm()">Reset Form</button>

    <!-- 4. OUTPUT -->
    <div class="section">
        <h2>4. Output</h2>
        <div class="row">
            <button onclick="copyToClipboard()">Copy to Clipboard</button>
            <button onclick="downloadFile()">Download .json</button>
        </div>
        <br>
        <pre id="output"></pre>
    </div>

    <script>
        let currentDataObj = { name: "", data: [] };

        // --- EVENT LISTENERS ---

        // 1. Handle JSON Upload
        document.getElementById('fileJson').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    currentDataObj = json;
                    
                    // Auto-fill Group Name if exists
                    if (json.name) document.getElementById('txtGroup').value = json.name;
                    
                    document.getElementById('jsonStatus').innerText = 
                        `Loaded "${json.name}" with ${json.data.length} existing entries.`;
                    document.getElementById('jsonStatus').style.color = "#03dac6";
                    
                    updateOutput();
                } catch (err) {
                    alert("Error parsing JSON file");
                }
            };
            reader.readAsText(file);
        });

        // 2. Handle CSV Upload
        document.getElementById('fileCsv').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('txtCsvInput').value = e.target.result;
            };
            reader.readAsText(file);
        });

        // --- MAIN LOGIC ---

        function processData() {
            const groupName = document.getElementById('txtGroup').value.trim();
            const entryName = document.getElementById('txtName').value.trim();
            const rawCsv = document.getElementById('txtCsvInput').value.trim();

            if (!groupName || !entryName || !rawCsv) {
                alert("Please fill in Group Name, Entry Name, and CSV Data.");
                return;
            }

            // 1. Parse CSV Points
            const lines = rawCsv.split(/\r?\n/);
            const points = [];
            
            lines.forEach(line => {
                if (line.trim() === "") return;
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const lat = parseFloat(parts[0].trim());
                    const lon = parseFloat(parts[1].trim());
                    if (!isNaN(lat) && !isNaN(lon)) {
                        points.push([lat, lon]);
                    }
                }
            });

            if (points.length < 3) {
                alert("Error: Found fewer than 3 valid coordinate points.");
                return;
            }

            // 2. Calculate Bounding Box
            let minLat = Infinity, maxLat = -Infinity;
            let minLon = Infinity, maxLon = -Infinity;

            points.forEach(p => {
                if (p[0] < minLat) minLat = p[0];
                if (p[0] > maxLat) maxLat = p[0];
                if (p[1] < minLon) minLon = p[1];
                if (p[1] > maxLon) maxLon = p[1];
            });

            // 3. Create Entry Array
            // Format: [minLat, maxLat, minLon, maxLon, "Name", [[points]]]
            const newEntry = [
                minLat, 
                maxLat, 
                minLon, 
                maxLon, 
                entryName, 
                points
            ];

            // 4. Merge into Main Object
            currentDataObj.name = groupName;
            currentDataObj.data.push(newEntry);

            // 5. Success UI
            updateOutput();
            alert(`Successfully added "${entryName}"!`);
            
            // Clear inputs for next entry (keep Group name)
            document.getElementById('txtName').value = "";
            document.getElementById('txtCsvInput').value = "";
            document.getElementById('fileCsv').value = "";
        }

        function updateOutput() {
            const jsonStr = JSON.stringify(currentDataObj, null, 2);
            document.getElementById('output').innerText = jsonStr;
        }

        function copyToClipboard() {
            const text = document.getElementById('output').innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert("JSON copied to clipboard!");
            });
        }

        function downloadFile() {
            const text = document.getElementById('output').innerText;
            if (!text) return;
            
            const groupName = document.getElementById('txtGroup').value || "data";
            const filename = groupName.replace(/[^a-z0-9]/gi, '_').toLowerCase() + ".json";
            
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function clearForm() {
            if(confirm("Clear all data and start over?")) {
                currentDataObj = { name: "", data: [] };
                document.getElementById('txtGroup').value = "";
                document.getElementById('txtName').value = "";
                document.getElementById('txtCsvInput').value = "";
                document.getElementById('fileCsv').value = "";
                document.getElementById('fileJson').value = "";
                document.getElementById('jsonStatus').innerText = "No existing file loaded. Creating new.";
                document.getElementById('output').innerText = "";
            }
        }

    </script>
</body>
</html>
